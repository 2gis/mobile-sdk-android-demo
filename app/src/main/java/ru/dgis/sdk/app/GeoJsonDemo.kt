package ru.dgis.sdk.app

import ru.dgis.sdk.context.Context
import ru.dgis.sdk.map.*
import ru.dgis.sdk.map.Map

class GeoJsonDemo(
    private val context: Context,
    private val map: Map)
{
    private val source: GeometryMapObjectSource by lazy {
        GeometryMapObjectSourceBuilder(context).createSource()!!.apply {
            map.addSource(this)
        }
    }

    private val someGeoJsonObjects = """
    {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.09165954589844,
                  54.842667102073655
                ],
                [
                  83.09595108032227,
                  54.843408445360694
                ],
                [
                  83.09723854064941,
                  54.842667102073655
                ],
                [
                  83.10951232910156,
                  54.84810330324485
                ],
                [
                  83.09698104858398,
                  54.8573431644563
                ],
                [
                  83.09337615966797,
                  54.855762161832175
                ],
                [
                  83.09140205383301,
                  54.850771715802885
                ],
                [
                  83.09097290039062,
                  54.84558297376782
                ],
                [
                  83.09165954589844,
                  54.842667102073655
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.09715270996092,
                  54.85754078542685
                ],
                [
                  83.11062812805174,
                  54.86327137236375
                ],
                [
                  83.1104564666748,
                  54.8638641452251
                ],
                [
                  83.09783935546875,
                  54.86381474781949
                ],
                [
                  83.0921745300293,
                  54.86875418883671
                ],
                [
                  83.08951377868652,
                  54.86974200442524
                ],
                [
                  83.08015823364258,
                  54.869593833629985
                ],
                [
                  83.07990074157715,
                  54.859714552194355
                ],
                [
                  83.09466361999512,
                  54.85946753914407
                ],
                [
                  83.09715270996092,
                  54.85754078542685
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.09715270996092,
                  54.85729375906238
                ],
                [
                  83.10968399047852,
                  54.84810330324485
                ],
                [
                  83.11114311218262,
                  54.84627484459517
                ],
                [
                  83.11140060424805,
                  54.845632393506065
                ],
                [
                  83.11526298522949,
                  54.845533553969034
                ],
                [
                  83.12067031860352,
                  54.84795505292774
                ],
                [
                  83.12298774719238,
                  54.842518831781895
                ],
                [
                  83.12616348266602,
                  54.842469408230265
                ],
                [
                  83.12556266784668,
                  54.857392569789724
                ],
                [
                  83.12092781066895,
                  54.85818304689371
                ],
                [
                  83.11062812805174,
                  54.863172576039666
                ],
                [
                  83.09715270996092,
                  54.85729375906238
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.1112289428711,
                  54.845484134109746
                ],
                [
                  83.10951232910156,
                  54.848350385896175
                ],
                [
                  83.09706687927246,
                  54.84271652538315
                ],
                [
                  83.09552192687987,
                  54.843408445360694
                ],
                [
                  83.08736801147461,
                  54.84167862317162
                ],
                [
                  83.07758331298828,
                  54.8370324479972
                ],
                [
                  83.08015823364258,
                  54.836290987578195
                ],
                [
                  83.08856964111328,
                  54.83095207047366
                ],
                [
                  83.11200141906738,
                  54.841085524208296
                ],
                [
                  83.11251640319824,
                  54.842123441673856
                ],
                [
                  83.11105728149414,
                  54.844199196521984
                ],
                [
                  83.1112289428711,
                  54.845484134109746
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.08839797973633,
                  54.830655443263566
                ],
                [
                  83.10127258300781,
                  54.82165671546502
                ],
                [
                  83.10882568359375,
                  54.827689051291934
                ],
                [
                  83.11320304870605,
                  54.827392400107485
                ],
                [
                  83.12041282653809,
                  54.83090263275665
                ],
                [
                  83.12273025512695,
                  54.83312727008725
                ],
                [
                  83.12676429748534,
                  54.8340665245971
                ],
                [
                  83.12624931335449,
                  54.842419984618076
                ],
                [
                  83.12247276306151,
                  54.842568255273
                ],
                [
                  83.12041282653809,
                  54.847757384990864
                ],
                [
                  83.11517715454102,
                  54.845731232800965
                ],
                [
                  83.11097145080565,
                  54.845632393506065
                ],
                [
                  83.11105728149414,
                  54.84410035347425
                ],
                [
                  83.1126022338867,
                  54.84222228956404
                ],
                [
                  83.1119155883789,
                  54.84103609890123
                ],
                [
                  83.08839797973633,
                  54.830655443263566
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 269488144,
            "border_color": 1074794512,
            "border_width_zpt": 1.5,
            "is_monochrome": null},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  83.09689521789551,
                  54.8573431644563
                ],
                [
                  83.09432029724121,
                  54.85966514970532
                ],
                [
                  83.07595252990723,
                  54.85986275929828
                ],
                [
                  83.07492256164551,
                  54.85778781027834
                ],
                [
                  83.0647087097168,
                  54.846719612433766
                ],
                [
                  83.07097434997559,
                  54.83846589951909
                ],
                [
                  83.07809829711914,
                  54.8370324479972
                ],
                [
                  83.08728218078612,
                  54.84167862317162
                ],
                [
                  83.09174537658691,
                  54.84271652538315
                ],
                [
                  83.09062957763672,
                  54.8454347141899
                ],
                [
                  83.09123039245604,
                  54.8510681951925
                ],
                [
                  83.09294700622559,
                  54.85556453214666
                ],
                [
                  83.09638023376465,
                  54.8573431644563
                ],
                [
                  83.09689521789551,
                  54.8573431644563
                ]
              ]
            ]
          }
        }
      ]
    }
    """

    private val sberLogo = """
    {
    "type": "FeatureCollection",
    "features":[
    {
        "type": "Feature",
        "properties": {
            "db_sublayer": "s_dynamic_polygon",
            "color": 806025021,
            "border_color": 4280628777,
            "border_width_zpt": 1.5,
            "is_monochrome": null
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [83.134582, 54.862903],
                    [83.130743, 54.864263],
                    [83.125576, 54.865282],
                    [83.121294, 54.865707],
                    [83.118194, 54.865452],
                    [83.113469, 54.864518],
                    [83.108302, 54.863328],
                    [83.104611, 54.861884],
                    [83.102249, 54.859844],
                    [83.099591, 54.856785],
                    [83.09841, 54.854065],
                    [83.099148, 54.85211],
                    [83.099739, 54.84888],
                    [83.101067, 54.846755],
                    [83.104316, 54.843865],
                    [83.109778, 54.84157],
                    [83.115684, 54.840209],
                    [83.121294, 54.839529],
                    [83.127938, 54.840464],
                    [83.134139, 54.84225],
                    [83.139601, 54.84582],
                    [83.142554, 54.849475],
                    [83.143588, 54.85211],
                    [83.14285, 54.855],
                    [83.137682, 54.853385],
                    [83.137535, 54.850835],
                    [83.136796, 54.848795],
                    [83.134434, 54.84616],
                    [83.130891, 54.844545],
                    [83.127347, 54.843185],
                    [83.122918, 54.84259],
                    [83.117898, 54.842675],
                    [83.112583, 54.84361],
                    [83.107859, 54.845735],
                    [83.104316, 54.84888],
                    [83.10343, 54.854065],
                    [83.104611, 54.856785],
                    [83.107711, 54.859079],
                    [83.113026, 54.861374],
                    [83.117603, 54.862138],
                    [83.122623, 54.862223],
                    [83.126609, 54.861629],
                    [83.129857, 54.860524],
                    [83.134139, 54.862478],
                    [83.134582, 54.862903]
                ],
                [
                    [83.137682, 54.860609],
                    [83.119818, 54.85296],
                    [83.111993, 54.85568],
                    [83.11155, 54.852195],
                    [83.119522, 54.849135],
                    [83.140783, 54.857805],
                    [83.137682, 54.860609]
                ]
            ]
        }
    }]}
    """

    private fun parseGeoJsonFromString(geoJson: String) {
        GeometryMapObjectCreator.parseGeojson(geoJson)
            .filterNotNull()
            .forEach(source::addObject)
    }

    fun drawSberLogo() {
        parseGeoJsonFromString(sberLogo)
    }

    fun drawSomeGeoJsonObjects() {
        parseGeoJsonFromString(someGeoJsonObjects)
    }

    fun removeAllObjects() {
        source.clear()
    }

    fun toggleVisibility() {
        source.objects()
            .filterNotNull()
            .forEach {it.setVisible(!(it.isVisible().value ?: true))
        }
    }

}